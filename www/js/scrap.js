
var i18nMessages = {"ad.category.010":"Ostatné kovy","notify.hour":"Every %s hour","ad.subcategory.005012":"Iné","ad.subcategory.005011":"Ms rafinačka","ad.subcategory.005010":"Ms triesky mix","notify.minutes":"Every %s minutes","address":"Adresa","categories":"Kategórie","ad.buy":"Dopyt","ad.sell":"Ponuka","ad.category.009":"Legovaný odpad nerez","ad.category.008":"Cín","ad.category.007":"Zinok","ad.category.006":"Olovo","ad.category.005":"Mosadz","minute":"minúta","ad.category.004":"Bronz","tagline":"Tu nájdete všetko pod jednou strechou","ad.subcategory.005009":"Tombak","ad.category.003":"Meď","ad.subcategory.005008":"Alpaka","ad.category.002":"Hliník sekundárny","ad.subcategory.005007":"Ms \"Kartuschen\"","ad.category.001":"Hliník","ad.subcategory.005006":"Ms nábojnice","feature.3.text":"Lorem ipsum dolor sit amet consectetur incididunt ut labore et dolore magna aliqua adipisicing elit seddo eiusmod ","ad.subcategory.005005":"Ms 58 triesky čisté","ad.subcategory.005004":"Ms kondenzačné trubky","input.password":"Heslo","ad.subcategory.005003":"Ms 58","ad.subcategory.005002":"Ms 63","ad.subcategory.005001":"Ms kohutiková","cancel":"Zrušiť","ad.subcategory":"Podkategoria","companyTaxId":"DIČ spoločnosti","registration.type.personal":"Súkromná osoba","ad.pricetype.002":"Aukcia","ad.subcategory.001014":"AlMn odpad","ad.pricetype.001":"Inzerát","ad.subcategory.001013":"AlMg3","ad.subcategory.001012":"AlMg výseky nové","ad.subcategory.001011":"AlMg plechy s foliou","ad.subcategory.001010":"AlMg plechy nové,lesklé","days":"dní","ad.price":"Cena","seconds":"sekúnd","profile":"Uzivatelsky profil","ads":"Inzeráty","ad.amount":"Mnozstvo","event.004":"Dobitie kreditu","country.Czech":"Česká republika","event.003":"Pridanie ponuky v aukcii","event.002":"Otvorenie inzerátu","ad.subcategory.001009":"AlSi 1 profily","event.001":"Otvorenie inzerátu","usrPhone":"Telefon","ad.subcategory.001008":"Al kovolisty","ad.subcategory.001007":"Al pasnice","registration.personalDetails":"Osobné údaje","ad.subcategory.001006":"Al drát 99,5 oxidovaný","ad.subcategory.001005":"Al drát 99,5 nový","login.login":"Prihlasovacie meno","ad.subcategory.001004":"AlMg profily lakované","ad.subcategory.001003":"Al plech 99,5 nový","ad.subcategory.001002":"AlMgSi 0,5 profily lesklé,nové","hour":"hodinu","ad.subcategory.001001":"Aluminium primárny","registration.now":"Zaregistrujte sa teraz!","phone":"Tel.","company":"Spoločnosť","services":"Služby a poplatky","Sed":"perspiciatis unde omnisiste natus error voluptatem remopa accusantium doloremque laudantium, totam rem aperiam.","ad.subcategory.002022":"Iné","ad.subcategory.002021":"Al plechovky","input.first":"Krstné meno","ad.subcategory.002020":"Al fľašove uzávery","ad.subcategory.006007":"Iné","ad.subcategory.006006":"Pb batérie","ad.subcategory.006005":"Pb guľky,diabolky,broky","ad.subcategory.006004":"Tlačiarenske olovo","ad.subcategory.006003":"Pb mašle","ad.subcategory.006002":"Vyvažovacie olovka","ad.subcategory.006001":"Pb odpad starý","input.login":"Prihlasovacie meno","cellPhone":"Mobil","register":"Odoslať","companyName":"Názov spoločnosti","feature.4.text":"Lorem ipsum dolor sit amet consectetur incididunt ut labore et dolore magna aliqua adipisicing elit seddo eiusmod ","ad.subcategory.002019":"Al žaluzie","ad.subcategory.002018":"Al značky","login":"Prihlasenie","ad.subcategory.002017":"Al “sendvič” plechy","ad.subcategory.002016":"Al rafinacia","why.us":"Preco si vybrat nas","ad.subcategory.002015":"Al kable","ad.subcategory.002014":"Al Fe laná","all.ads":"Všetky inzeráty","ad.subcategory.002013":"Al folie","ad.subcategory.002012":"Al triesky","ad.subcategory.002011":"Al kusový","ad.subcategory.002010":"Al disky","minutes":"minút","notify.hours":"Every %s hours","billingAddressState":"Krajina","country.Austria":"Rakúsko","billingAddressCity":"Mesto","ad.subcategory.003030":"Iné","ad.subcategory.002009":"Al liaty 2\u0026#37;","ad.subcategory.002008":"Al liaty bez Fe(nový+starý)","on.time":"v case","ad.subcategory.002007":"Al Cu chladiče s Fe","ad.subcategory.002006":"Lamely z Al chladičov","contact.us":"Kontaktujte nás","ad.subcategory.002005":"Al plechy s 2\u0026#37;Fe","ad.subcategory.002004":"Al plechy lakované(mix)","ad.subcategory.002003":"Al plechy nové","ad.subcategory.002002":"AlMgSi 0,5 profily s PVC nové","input.password.repeat":"Potvrdenie hesla","ad.subcategory.002001":"AlMgSi 0,5 profily s PVC staré","country.Poland":"Poľsko","ad.type.006":"Ponuka práce","ad.type.005":"Doprava","rating.4-Nepravdivé":"udaje","newest.ads":"Najnovsie inzeraty","ad.type.004":"Použitý stroj","ad.type.003":"Likvidácia","login.register":"Zaregistrujte sa tu.","ad.type.002":"Zmiešaný šrot","registration.personal":"Registrácia - osobný účet","login.question":"Este nemáte účet?","no.reviews":"Zatial ziadne hodnotenia","ad.type.001":"Kovový šrot","why.us.text":"Pretoze sme jedini na trhu. Lorem ipsum dolor sit amet consectetur incididunt ut labore et dolore magna aliqua adipisicing elit seddo eiusmod tempor.","ad.subcategory.003029":"Chladničkové motory","call.us":"Zavolajte nám","ad.subcategory.003028":"Elektromotory","ad.subcategory.003027":"Cu drát s papierom","ad.subcategory.003026":"Cu káble mastné","usrCellPhone":"Mobil","ad.subcategory.003025":"Cu zemné káble","invalid.captcha":"Invalid captcha","ad.subcategory.003024":"Cu káble k lupaniu","ad.subcategory.003023":"Cu káble s PVC","show.more":"Zobrazit vsetky hodnotenia","ad.subcategory.003022":"Cu káble","ad.subcategory.003021":"Cu Ms chladiče","review":"Hodnotenie","ad.subcategory.003020":"Cu trafa","credit":"Kredit","ad.subcategory.007006":"Iné","ad.subcategory.007005":"Zn vyvažovacie závažia","ad.subcategory.007004":"Zn zliatina stará s Fe","ad.subcategory.007003":"Zn zliatina nová,bez Fe","about.us":"O nás","ad.subcategory.007002":"Zn odpad starý","ad.subcategory.007001":"Zn odpad nový","logout":"Odhlásiť sa","registration.type.business":"Firma","ad.subcategory.003019":"Cu Wicu-trubky","ad.subcategory.003018":"Cu triesky","ad.subcategory.003017":"Cu cievky","feature.1.text":"Lorem ipsum dolor sit amet consectetur incididunt ut labore et dolore magna aliqua adipisicing elit seddo eiusmod ","ad.subcategory.003016":"Cu ľahká","ad.subcategory.003015":"Cu drát lakovaný","ad.subcategory.003014":"Cu “kanal” drát","ad.subcategory.003013":"Cu Raff 95\u0026#37;","ad.subcategory.003012":"Cu postriebrena","ad.subcategory.003011":"Cu poniklovaná","ad.subcategory.003010":"Cu kusová ťažka","rating.6-Nedodal":"tovar","usrFax":"Fax","hours":"hodín","log.in":"Prihlásiť sa","motivation2":"Nevahajte a zaregistrujte sa uz dnes.","motivation1":"STI je spolocnost zaoberajuca sa spravovanim informacii o srote.a vsetkych suvisiacich cinnostiach","input.last":"Priezvisko","notify.day":"Every day at %s","ad.subcategory.003009":"Cu plech,trubky nové","ad.subcategory.003008":"Cu drát holý","ad.subcategory.003007":"Cu pasnice lakované","ad.subcategory.003006":"Cu pasnice lesklé","ad.subcategory.010010":"Iné","ad.subcategory.003005":"Cu drát zelený","ad.url":"Odkaz na inzerat","ad.subcategory.003004":"Cu pocinovana","ad.subcategory.003003":"Cu granulát","ad.subcategory.003002":"Cu drát nový,lesklý","ad.subcategory.003001":"Cu katody","billingAddressStreet":"Ulica","save":"Ulozit","ad.category":"Kategoria","country.Hungary":"Maďarsko","ad.subcategory.010009":"Wolfrám","ad.subcategory.010008":"Molybdén","ad.subcategory.010007":"Katalyzátory","ad.subcategory.010006":"NI Zliatiny","companyId":"IČO spoločnosti","ad.subcategory.010005":"Niresist","ad.subcategory.010004":"Tvrdokov","ad.subcategory.010003":"Ti triesky","welcome":"Vitajte v portali STI","ad.subcategory.010002":"Ti odpad","ad.subcategory.010001":"Magnezium","registration.type":"Typ registrácie","ad.subcategory.008004":"Iné","ad.subcategory.008003":"Sn stery","ad.subcategory.008002":"Sn pájka","ad.subcategory.008001":"Sn čistý","feature.4":"Vsetko pod jednou strechou","notify.seconds":"Every %s seconds","feature.3":"Setrime Vam naklady","registration.accountDetails":"Údaje o spoločnosti","feature.2":"Setrime Vam cas","feature.1":"Vytvorene pre Vas biznis","contact":"Kontaktne udaje","rating.5-Neodpovedal":"","ad.type":"Typ","registration.business":"Registrácia - firma","registration.login":"Prihlasovacie meno v tvare emailu","display.all.ads":"Zobrazit vsetky","feature.2.text":"Lorem ipsum dolor sit amet consectetur incididunt ut labore et dolore magna aliqua adipisicing elit seddo eiusmod ","registration":"Registrácia","ad.subcategory.004006":"Iné","ad.subcategory.004005":"Bz Ms triesky","ad.subcategory.004004":"Bronz magnetický","ad.subcategory.004003":"Bronz cínový valcovaný","ad.subcategory.004002":"Bronz cínový kusový","fax":"Fax","rating.3":"Som spokojný","ad.subcategory.004001":"Bronz červený a triesky","rating.2":"Rýchla dohoda","rating.1":"Som maximálne spokojný","day":"deň","second":"sekunda","ad.state.003":"Vyprsana platnost inzeratu","ad.state.002":"Publikovany","home":"Domov","usrEmail":"Email","ad.state.001":"Nepublikovany","country.Slovakia":"Slovenská republika","ad.subcategory.009009":"Iné","added":"Pridane","ad.subcategory.009008":"NCT odpad","ad.subcategory.009007":"Ni odpad","email":"Email","ad.subcategory.009006":"Cr/Ni/Mo 18/10/2 triesky","ad.subcategory.009005":"Cr/Ni/Mo 18/10/2","ad.subcategory.009004":"Cr/Ni 18/8 triesky","ad.subcategory.009003":"Cr/Ni 18/8","ad.subcategory.009002":"Cr triesky","ad.subcategory.009001":"Cr odpad"};


/**
* Fixme : only parse single char formatters eg. %s
*/
var i18n = function(code) {
var message = i18nMessages && i18nMessages[code] || code;
// Encode %% to handle it later
message = message.replace(/%%/g, "\0%\0");
if (arguments.length > 1) {
// Explicit ordered parameters
for (var i=1; i<arguments.length; i++) {
    var r = new RegExp("%" + i + "\\$\\w", "g");
    message = message.replace(r, arguments[i]);
}
// Standard ordered parameters
for (var i=1; i<arguments.length; i++) {
    message = message.replace(/%\w/, arguments[i]);
}
}
// Decode encoded %% to single %
message = message.replace("\0%\0", "%");
// Imbricated messages
var imbricated = message.match(/&\{.*?\}/g);
if (imbricated) {
for (var i=0; i<imbricated.length; i++) {
    var imbricated_code = imbricated[i].substring(2, imbricated[i].length-1).replace(/^\s*(.*?)\s*$/, "$1");
    message = message.replace(imbricated[i], i18nMessages[imbricated_code] || "");
}
}
return message;
};




var MyLocalStorage = {};

MyLocalStorage.getItem = function(key) {
    if(localStorage.getItem(key) != null)
        return JSON.parse(localStorage.getItem(key));
    return null;
};

MyLocalStorage.setItem = function(key, object) {
    localStorage.setItem(key, JSON.stringify(object));
};

MyLocalStorage.removeItem = function(key) {
    localStorage.removeItem(key);
};

var scrap = {
    parseJson : function(json){
        if(json != null || json != undefined){
            var obj = JSON.parse(json);  
            return obj;
        }
        return null;
    },    
        
    refresh: 20000,
    host: "http://192.168.1.100:9002",
    
    // container for current ad images
    images : [],
    
    init: function(){
        $( "#popupSettings" ).enhanceWithin().popup();
        
        
        // notifications pooler
        scrap.refresh = MyLocalStorage.getItem("refresh");
        if(scrap.refresh == null || scrap.refresh == undefined){
            scrap.refresh = 20000;
            MyLocalStorage.setItem("refresh", scrap.refresh);
        }
        $('input:radio[name="refresh"]').filter('[value="'+scrap.refresh+'"]').attr('checked', true);
        
        scrap.host = MyLocalStorage.getItem("host");
        if(scrap.host == null || scrap.host == undefined){
            scrap.host = "http://192.168.1.100:9002";
            MyLocalStorage.setItem("host", scrap.host);
        }
        $('input:radio[name="baseUrl"]').filter('[value="'+scrap.host+'"]').attr('checked', true);
        
        // notifications pooler
        scrap.interval = setInterval(function(){
            scrap.updateNotifications();
        }, scrap.refresh);
        
        // register i18n function
        Handlebars.registerHelper('i18n',
            function(str){
              return (i18n != undefined ? i18n(str) : str);
        }
        );
        
        
        // check logged user
        if(MyLocalStorage.getItem("password") == null || MyLocalStorage.getItem("login") == null){
            $.mobile.navigate( "#login", { transition: "slide" });
        } else {
            $.mobile.navigate("#page1");
            scrap.listAds();
            scrap.listNotifications();
        }
        
        // button handlers 
        $(".btn-logout").click(function(){
            scrap.logout();
            MyLocalStorage.removeItem("ads");
            MyLocalStorage.removeItem("notifications");
        });
        
        $("#loginButton").click(function(){
            scrap.login();
        });        

        $("#newAdSubmit").click(function(){
            scrap.newAd();
        });        
        
        $("#newAdSubmitSend").click(function(){
            scrap.postAdSend();
        });        
        
        $("#photo-button").click(function(){
            scrap.takePhoto();
        }); 
        
        $("#settingsClear").click(function(){
            MyLocalStorage.removeItem("notifications");
            scrap.listNotifications();
            alert("Dáta  boli odstranené")
        });    

        $("#settingsSave").click(function(){
            scrap.refresh = $('input[name=refresh]:checked').val();
            MyLocalStorage.setItem("refresh", scrap.refresh);
            scrap.host = $('input[name=baseUrl]:checked').val();
            MyLocalStorage.setItem("host", scrap.host);
            
            // notifications pooler
            clearInterval(scrap.interval);
            scrap.interval = setInterval(function(){
                scrap.updateNotifications();
            }, scrap.refresh);
            
            alert("Zmeny boli uložené");
            $.mobile.navigate("#page1");
        });  
        
        $("body").on("click", ".new-ad-send", scrap.postAdFromStore);    
        $("body").on("click", ".new-ad-delete", scrap.deleteAd);    
        $("body").on("click", ".notification-delete", scrap.deleteNotification);    
        
        // add regex functionality to selectors
        jQuery.expr[':'].regex = function(elem, index, match) {
            var matchParams = match[3].split(','),
                validLabels = /^(data|css):/,
                attr = {
                    method: matchParams[0].match(validLabels) ? 
                                matchParams[0].split(':')[0] : 'attr',
                    property: matchParams.shift().replace(validLabels,'')
                },
                regexFlags = 'ig',
                regex = new RegExp(matchParams.join('').replace(/^\s+|\s+$/g,''), regexFlags);
            return regex.test(jQuery(elem)[attr.method](attr.property));
        }
        
        // init form
        scrap.form();
        scrap.selectbox();
    },
    
    updateNotifications: function(){
        if(!scrap.checkConnection()){
            console.log("Internet je odpojený");
            return;
        }
            
        var login = MyLocalStorage.getItem("login");
        var password = MyLocalStorage.getItem("password");
        $.ajax({
            type: "GET",
            url: scrap.host+"/mobile-notifications?login="+login,
            success: function(data){
                if(data != null && data.length > 0){
                    //alert("Notification " + JSON.stringify(data));
                    
                    // initiate notifications list
                    var nlist = MyLocalStorage.getItem("notifications");
                    if(nlist == null || nlist == undefined)
                        nlist = [];


                    // add items to nlist
                    for(var i = 0; i < data.length; i++){
                        data[data.length - 1].first = true;

                        data[i].typeLabel = i18n("ad.type."+data[i].type);
                        data[i].categoryLabel = i18n("ad.category."+data[i].category);
                        data[i].subCategoryLabel = i18n("ad.subcategory."+data[i].subCategory);
                        nlist.push(data[i]);
                    }
                    
                    // delete n oldest items from begin of array
                    if(nlist.length >= 50){
                        for(var i = 0; i < data.length; i++){
                            nlist.shift();
                        }
                    }
                    
                    // push notification and redraw notification list
                    MyLocalStorage.setItem("notifications", nlist);
                    scrap.listNotifications();
                    
                    if(data.length >= 5)
                        window.plugin.notification.local.add({ message: "Máte "+ data.length + " nových upozornení."}); 
                    else if(data.length == 1)
                        window.plugin.notification.local.add({ message: "Máte "+ data.length + " nové upozornenie."}); 
                    else if(data.length > 1 && data.length < 5)
                        window.plugin.notification.local.add({ message: "Máte "+ data.length + " nové upozornenia."}); 
                }
            },
            error: function(err){
                alert("Vyskytla sa chyba " + JSON.stringify(err));
            },
            contentType: "application/json"
        });     
    },
    
    
    cleanForm: function(){
        $("#imageContainer").html("");
        scrap.images = [];
        $("#price").val("");
        $("#amount").val("");
    },
    
    
    getAdFromStorage: function(id){
        var ads = MyLocalStorage.getItem("newAds");
        var ad = null;
        for(var i = 0; i < ads.length; i++){
            if(ads[i].uuid == id){
                ad = ads[i];
            }
        }     
        return ad;
    },
    
    postAdSend: function(){
        var ad = {};
        ad.images = scrap.images;
        ad.buySell = $('input[name=buySell]:checked').val();
        ad.priceType = $('input[name=priceType]:checked').val();
        ad.type = $("#type").val();
        ad.category = $("#category").val();
        ad.subCategory = $("#subCategory").val();
        ad.price = $("#price").val();
        ad.amount = $("#amount").val();
        ad.uuid  = scrap.guid();
        ad.login = MyLocalStorage.getItem("login");
        ad.password = MyLocalStorage.getItem("password");
        
        scrap.postAd(ad);
    },
    
    
    postAd: function(ad){
        if(scrap.checkConnection()){
            scrap.postAdAjax(ad, null, function(){
                //alert("new Ad images:" + JSON.stringify(ad.images));
                if(ad.images != undefined && ad.images != null && ad.images.length > 0){
                    for(var i = 0; i < ad.images.length; i++){
                        //alert("image to send: " + ad.images[i]);
                        var options = new FileUploadOptions();
                        options.fileKey = "file";
                        options.fileName = "test.jpg";
                        options.mimeType = "image/jpeg";
                        options.params = {};
                        options.params.login = MyLocalStorage.getItem("login");
                        options.params.password = MyLocalStorage.getItem("password");
                        options.params.id = ad.uuid;

                        // send images
                        var ft = new FileTransfer();
                        ft.upload(ad.images[i], encodeURI(scrap.host + "/mobile-upload"), function(){
                            scrap.deleteNewAd(ad.uuid);
                            scrap.cleanForm();
                            alert("Inzerat bol úspešne odoslaný");
                        }, function(data){
                            alert("Chyba " + JSON.stringify(data))
                        }, options);
                    }
                } else {
                    scrap.deleteNewAd(ad.uuid);
                    scrap.cleanForm();
                    alert("Inzerat bol úspešne odoslaný");
                }
            }, function(){
                alert("Vyskytla sa chyba");
            });    
        } else {
            alert("Internet je odpojený");
        }
    },
    
    postAdFromStore: function(){
        var id = $(this).attr("data-id");
        var ad = scrap.getAdFromStorage(id);
        scrap.postAd(ad);
    },

    deleteAd: function(){
        var ads = MyLocalStorage.getItem("newAds");
        var ad = $(this).attr("data-id");
        var index = -1;
        
        // find index
        for(var i = 0; i < ads.length; i++){
            if(ads[i].uuid == ad){
                index = i;
                break;
            }
        }          
        
        if(index > -1){
            ads.splice(index, 1);
            console.log(ads);
            MyLocalStorage.setItem("newAds", ads);
            scrap.listAds();
        }
        $( ".popups" ).popup("close");
    },
    
    deleteNotification: function(){
        var notifications = MyLocalStorage.getItem("notifications");
        var notif = $(this).attr("data-id");
        
        // find index
        for(var i = 0; i < notifications.length; i++){
            if(notifications[i].uuid == notif){
                if(i > -1){
                    notifications.splice(i, 1);
                    MyLocalStorage.setItem("notifications", notifications);
                    scrap.listNotifications();
                }
                break;
            }
        }          
        $( ".popups" ).popup("close");
    },
    
    
    deleteNewAd: function(ad){
        var ads = MyLocalStorage.getItem("newAds");
        for(var i = 0; i < ads.length; i++){
            if(ads[i].uuid == ad){
                ads.splice(i, 1);
                MyLocalStorage.setItem("newAds", ads);
                scrap.listAds();
            }
            $( ".popups" ).popup("close");
        }          
    },
    
    
    selectbox: function(){
        $('option:regex(value,00[0-9][0-9][0-9][0-9])').hide();
        
        // by default show first category 
        if($("#type").val() == "001")
            $("#001").show();
        
        $("#type").change(function(){
            var selected = $(this).find(":selected").val();
            if(selected == "001"){
                $(".001").show();
            } else {
                $(".001").hide();
            }
        });             
        
        var generateOptions = function(){
            var selected = $(this).find(":selected").val();
            var elms = $('option:regex(value,'+selected+'[0-9][0-9][0-9])');
            $('#subCategory').html("<option value=''></option>");
            $.each(elms, function() {
                $('#subCategory').append($("<option/>", {
                    value: $(this).attr("value"),
                    text: $(this).text()
                }));
            });
            $("#subCategory").prop('selectedIndex',0);          
        }
        $("#category").change(generateOptions);
        $("#category").change();
    },    
    
    newAd: function(){
        var ad = {};
        ad.images = scrap.images;
        ad.buySell = $('input[name=buySell]:checked').val();
        ad.priceType = $('input[name=priceType]:checked').val();
        ad.type = $("#type").val();
        m = new Date();
        ad.created =  (m.getUTCDate()+1) +"."+ m.getUTCMonth()+"." +m.getUTCFullYear() + " " + m.getUTCHours() + ":" + m.getUTCMinutes() + ":" + m.getUTCSeconds();
        ad.category = $("#category").val();
        ad.subCategory = $("#subCategory").val();
        ad.price = $("#price").val();
        ad.amount = $("#amount").val();
        ad.uuid  = scrap.guid();
        ad.login = MyLocalStorage.getItem("login");
        ad.password = MyLocalStorage.getItem("password");
        
        // clean images
        $("#imageContainer").html();
        scrap.images = [];
        console.log(ad);
        
        var newAds = MyLocalStorage.getItem("newAds");
        if(newAds == null || newAds == undefined)
            newAds = [];
        
        newAds.push(ad);
        MyLocalStorage.setItem("newAds", newAds);
        
        // refresh ads
        scrap.listAds();
        
        $.mobile.navigate("#page2");
    },

    listAds: function() {
        var items = MyLocalStorage.getItem("newAds");
        for(var i in items){
            var item = items[i];
            item.typeLabel = i18n("ad.type."+item.type);
            item.categoryLabel = i18n("ad.category."+item.category);
            item.subCategoryLabel = i18n("ad.subcategory."+item.subCategory);
        }

        var source = $("#ads-template").html();
        var template = Handlebars.compile(source);
        var html = template({"items": items, "host" : scrap.host});
        $("#ads-container").html(html).trigger("create");
    },

    listNotifications: function() {
        var items = MyLocalStorage.getItem("notifications");
        if(items != null && items != undefined)
            items.reverse();
        var source = $("#notifications-template").html();
        var template = Handlebars.compile(source);
        var html = template({"items": items, "host" : scrap.host});        
        $("#notifications-container").html(html).trigger("create");
    },

    takePhoto: function() {
        var options = { quality : 100, 
                destinationType: Camera.DestinationType.FILE_URI, 
                correctOrientation : true,
                encodingType: Camera.EncodingType.JPEG,
                saveToPhotoAlbum: true
        };
        navigator.camera.getPicture(scrap.photoSuccess, scrap.photoFail, options);
    },

    photoSuccess: function(imageURI) {
        var images = $("#imageContainer");
        images.append("<img src='"+imageURI+"' style='height: 100px;'>")
        scrap.images.push(imageURI);
    },

    photoFail: function(message) {
        //alert('Failed because: ' + message);
    },
    
    logout: function() {
        MyLocalStorage.removeItem("password");
        MyLocalStorage.removeItem("login");
        $.mobile.navigate("#login", { transition: "slide" });
    },

    login: function() {
        MyLocalStorage.setItem("password", $("#password").val());
        MyLocalStorage.setItem("login", $("#loginValue").val());
        
        $("#loginValue").val(null);
        $("#password").val(null);
        scrap.listAds();
        scrap.listNotifications();

        $.mobile.navigate("#page1", { transition: "slide" });
    },
    
    footer: function() {
        //var html = nunjucks.render('footer.html');
        var source = $("#footer-template").html();
        var template = Handlebars.compile(source);
        var html = template();           
        $(".footer-container").html(html).trigger("create");
    },
    
    form: function() {
        var source = $("#ad-form-template").html();
        var template = Handlebars.compile(source);
        var html = template();           
        $(".ad-form-template").html(html).trigger("create");
    },

    header: function(param) {
        $(".header-container").each(function(){
            var param = $(this).attr("data-title");
            var html = nunjucks.render('header.html', {title: param});
            $(this).html(html).trigger("create");            
        });
    },
    
    checkConnection: function() {
        var networkState = navigator.connection.type;
        if(Connection.NONE == networkState)
            return false;
        return true;
    },
    
    getAds : function(params, success, error){
        console.log("%% GET " + scrap.host+"/ads?"+params);
        $.ajax({
            type: "GET",
            url: scrap.host+"/ads?"+params,
            success: success,
            error: function(err){
                console.log(err);
                console.log(err.status);
                console.log(err.statusText);
                console.log(err.responseText);
            },
            contentType: "application/json"
        });
    },

    postAdAjax : function(data, params, success, error){
        $.ajax({
            type: "POST",
            url: scrap.host+"/mobile-newAd",
            data: JSON.stringify(data),
            success: success,
            error: function(err){
                console.log("Error occured while posting to server "+scrap.host+"/mobile-newAd");
            },
            contentType: "application/json"
        });
    },
    
    isMobile : function() {
        var check = false;
        (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4)))check = true})(navigator.userAgent||navigator.vendor||window.opera);
        return check; 
    },    
    
    guid: function() {
        function _p8(s) {
            var p = (Math.random().toString(16)+"000000000").substr(2,8);
            return s ? "" + p.substr(0,4) + "" + p.substr(4,4) : p ;
        }
        return _p8() + _p8(true) + _p8(true) + _p8();
    }
};






